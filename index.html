<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To Your Point</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        #finalTranscript {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .highlight {
            background-color: yellow;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>To Your Point...</h1>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
    <button id="resetBtn">Reset</button>
    <div id="interimTranscript"></div>
    <div id="finalTranscript"></div>

    <script>
        const socket = io();
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resetBtn = document.getElementById('resetBtn');
        const interimTranscript = document.getElementById('interimTranscript');
        const finalTranscript = document.getElementById('finalTranscript');

        // Prefill the final transcript with sample text
        finalTranscript.innerHTML = `This is a sample transcript. You can highlight any part of this text by selecting it with your mouse. Click on a highlighted portion to remove the highlight. This feature allows you to easily mark important parts of the transcript. You can test the highlighting functionality right away without having to record actual speech. Feel free to try selecting different parts of this text to see how the highlighting works.`;

        startBtn.addEventListener('click', () => {
            socket.emit('startRecording');
            startBtn.disabled = true;
            stopBtn.disabled = false;
        });

        stopBtn.addEventListener('click', () => {
            socket.emit('stopRecording');
            startBtn.disabled = false;
            stopBtn.disabled = true;
        });

        resetBtn.addEventListener('click', () => {
            socket.emit('resetTranscript');
            finalTranscript.innerHTML = '';
            interimTranscript.textContent = '';
        });

        socket.on('transcription', (data) => {
            interimTranscript.textContent = data.interim;
            if (data.final !== undefined) {
                finalTranscript.innerHTML = data.final;
            }
        });

        socket.on('reload', () => {
            console.log('Server code changed. Reloading...');
            location.reload();
        });

        // Highlighting functionality
        finalTranscript.addEventListener('mouseup', () => {
            const selection = window.getSelection();
            if (!selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.className = 'highlight';
                range.surroundContents(span);
                selection.removeAllRanges();
            }
        });

        finalTranscript.addEventListener('click', (event) => {
            if (event.target.classList.contains('highlight')) {
                const parent = event.target.parentNode;
                const textNode = document.createTextNode(event.target.textContent);
                parent.replaceChild(textNode, event.target);
                parent.normalize(); // This merges adjacent text nodes
            }
        });
    </script>
</body>

</html>